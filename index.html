<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat IA con Memoria - OpenRouter</title>
    <style>
        :root {
            --primary: #7c3aed;
            --primary-dark: #6d28d9;
            --secondary: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --light: #f8fafc;
            --dark: #1e293b;
            --gray: #64748b;
            --light-gray: #e2e8f0;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --quote-color: #45f542;
            --asterisk-color: #ff0000;
            --asterisk-rgb: 255, 0, 0;
            --text-color: #1e293b;
            --bg-color: white;
            --message-bg-user: #7c3aed;
            --message-bg-ai: white;
            --message-text-user: white;
            --message-text-ai: #1e293b;
        }

        .dark-mode {
            --primary: #8b5cf6;
            --primary-dark: #7c3aed;
            --secondary: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --light: #1e293b;
            --dark: #f8fafc;
            --gray: #94a3b8;
            --light-gray: #334155;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
            --quote-color: #45f542;
            --asterisk-color: #ff0000;
            --asterisk-rgb: 255, 0, 0;
            --text-color: #f8fafc;
            --bg-color: #0f172a;
            --message-bg-user: #7c3aed;
            --message-bg-ai: #1e293b;
            --message-text-user: white;
            --message-text-ai: #f8fafc;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
        }
        
        body {
            background: transparent; /* Fondo transparente para eliminar el gradiente morado */
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0; /* Eliminar padding para maximizar espacio */
        }

        .dark-mode body {
            background: transparent; /* Fondo transparente en modo oscuro */
        }
        
        .container {
            width: 100vw; /* Ocupa todo el ancho de la ventana */
            height: 100vh; /* Ocupa todo el alto de la ventana */
            background: var(--bg-color);
            border-radius: 0; /* Eliminar bordes redondeados para ocupar todo el espacio */
            box-shadow: none; /* Eliminar sombra para un dise√±o m√°s limpio */
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
        }
        
        header {
            background: var(--dark);
            color: var(--light);
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .logo h1 {
            font-size: 1.6rem;
            font-weight: 700;
            color: var(--light);
        }
        
        .logo-icon {
            font-size: 2rem;
        }
        
        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .header-btn {
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(255, 255, 255, 0.1);
            color: var(--light);
            font-size: 0.9rem;
        }
        
        .header-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .theme-toggle {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: all 0.3s;
            color: var(--light);
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .api-status {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 16px;
            border-radius: 20px;
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--secondary);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .chat-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        .sidebar {
            width: 300px;
            background: var(--light);
            border-right: 1px solid var(--light-gray);
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            transition: all 0.3s ease;
        }
        
        .current-room-display {
            background: var(--light-gray);
            padding: 8px 12px;
            border-radius: 10px;
            font-size: 0.85rem;
            color: var(--text-color);
            text-align: center;
            font-weight: 600;
        }
        
        .config-section {
            background: var(--bg-color);
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .config-section h3 {
            color: var(--dark);
            margin-bottom: 15px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .config-section h3::before {
            content: "‚öôÔ∏è";
        }
        
        .form-group {
            margin-bottom: 10px;
        }
        
        .form-group label {
            display: block;
            font-weight: 600;
            color: var(--gray);
            font-size: 0.85rem;
            margin-bottom: 4px;
        }
        
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 8px 10px;
            border-radius: 8px;
            border: 1px solid var(--light-gray);
            background: var(--bg-color);
            font-size: 0.85rem;
            transition: border 0.3s;
            color: var(--text-color);
        }
        
        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
        }
        
        .model-search-container {
            position: relative;
            margin-bottom: 10px;
        }
        
        .model-search-input {
            width: 100%;
            padding: 8px 10px 8px 35px;
            border-radius: 8px;
            border: 1px solid var(--light-gray);
            background: var(--bg-color) url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="gray" viewBox="0 0 16 16"><path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/></svg>') no-repeat 10px center;
            background-size: 16px;
            font-size: 0.85rem;
            transition: border 0.3s;
            color: var(--text-color);
        }
        
        .model-search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
        }
        
        .model-search-input::placeholder {
            color: var(--gray);
        }
        
        .models-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 150px;
            overflow-y: auto;
            background: var(--bg-color);
            border: 1px solid var(--light-gray);
            border-radius: 8px;
            box-shadow: var(--shadow);
            z-index: 10;
            display: none;
        }
        
        .models-list.show {
            display: block;
        }
        
        .model-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid var(--light-gray);
            font-size: 0.85rem;
            transition: background 0.2s;
            color: var(--text-color);
        }
        
        .model-item:hover,
        .model-item.selected {
            background: var(--light-gray);
        }
        
        .model-item:last-child {
            border-bottom: none;
        }
        
        .model-display {
            padding: 8px 10px;
            background: var(--light-gray);
            border-radius: 8px;
            font-size: 0.8rem;
            color: var(--gray);
            min-height: 18px;
        }
        
        .api-keys-section {
            margin-top: 10px;
        }
        
        .api-keys-section select {
            width: 100%;
            padding: 8px 10px;
            border-radius: 8px;
            border: 1px solid var(--light-gray);
            background: var(--bg-color);
            font-size: 0.85rem;
            transition: border 0.3s;
            color: var(--text-color);
        }
        
        .api-keys-section select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
        }
        
        .btn {
            padding: 8px 12px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            font-size: 0.85rem;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }
        
        .btn-loading {
            background: var(--gray);
            color: white;
            cursor: not-allowed;
        }
        
        .chat-history {
            flex: 1;
            overflow-y: auto;
        }
        
        .chat-history h3 {
            color: var(--dark);
            margin-bottom: 15px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .chat-history h3::before {
            content: "üìö";
        }
        
        .history-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .history-item {
            padding: 12px 15px;
            border-radius: 10px;
            background: var(--bg-color);
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid transparent;
            font-size: 0.9rem;
            color: var(--text-color);
        }
        
        .history-item:hover {
            border-color: var(--primary);
            transform: translateX(5px);
        }
        
        .history-item.active {
            background: var(--primary);
            color: white;
        }
        
        .actions-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 15px;
        }
        
        .action-icon {
            padding: 10px;
            border-radius: 8px;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--light-gray);
            color: var(--text-color);
        }
        
        .action-icon:hover {
            transform: scale(1.05);
            background: var(--gray);
            color: white;
        }
        
        .action-icon.primary {
            background: var(--primary);
            color: white;
        }
        
        .action-icon.primary:hover {
            background: var(--primary-dark);
        }
        
        .action-icon.danger {
            background: var(--danger);
            color: white;
        }
        
        .action-icon.danger:hover {
            background: #dc2626;
        }
        
        .action-icon.theme {
            grid-column: span 2;
            background: var(--light-gray);
            color: var(--text-color);
            font-size: 1.5rem;
        }
        
        .action-icon.theme:hover {
            background: var(--gray);
            color: white;
        }
        
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 25px;
            position: relative;
        }

        .mobile-menu-btn {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            background: #FFD700;
            color: black;
            border: none;
            padding: 12px;
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
            z-index: 1001;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }

        .mobile-menu-btn:hover {
            background: #FFC107;
            transform: scale(1.05);
        }
        
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: var(--light);
            border-radius: 16px;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            transition: all 0.3s ease;
        }
        
        .message {
            max-width: 80%;
            padding: 16px 20px;
            border-radius: 18px;
            line-height: 1.5;
            position: relative;
            animation: fadeIn 0.4s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            white-space: pre-wrap; /* IMPORTANTE: Conserva saltos de l√≠nea */
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .user-message {
            align-self: flex-end;
            background: var(--message-bg-user);
            color: var(--message-text-user);
            border-bottom-right-radius: 6px;
        }
        
        .ai-message {
            align-self: flex-start;
            background: var(--message-bg-ai);
            color: var(--message-text-ai);
            border: 1px solid var(--light-gray);
            border-bottom-left-radius: 6px;
        }
        
        .message-header {
            font-size: 0.8rem;
            opacity: 0.8;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .message-header .actions {
            display: flex;
            gap: 4px;
        }
        
        .action-btn {
            background: none;
            border: none;
            color: inherit;
            cursor: pointer;
            font-size: 0.9rem;
            padding: 2px 6px;
            border-radius: 4px;
            transition: background 0.2s;
        }
        
        .action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .message-content {
            margin-top: 5px;
            white-space: pre-wrap; /* IMPORTANTE: Conserva saltos de l√≠nea */
        }

        /* Estilos para texto entre comillas */
        .quoted-text {
            color: var(--quote-color);
            font-weight: 600;
            padding: 2px 4px;
            border-radius: 4px;
            background: rgba(69, 245, 66, 0.1);
            white-space: normal; /* Para que el texto entre comillas se ajuste normalmente */
        }

        /* Estilos para texto entre asteriscos */
        .asterisk-text {
            color: var(--asterisk-color);
            font-weight: 600;
            padding: 2px 4px;
            border-radius: 4px;
            background: rgba(var(--asterisk-rgb), 0.1);
            white-space: normal;
        }
        
        .message.editing .message-content {
            display: none;
        }
        
        .edit-form {
            display: none;
            margin-top: 5px;
        }
        
        .message.editing .edit-form {
            display: block;
        }
        
        .edit-textarea {
            width: 100%;
            min-height: 60px;
            padding: 10px;
            border-radius: 8px;
            resize: vertical;
            font-size: 1rem;
            line-height: 1.5;
            border: 1px solid var(--primary);
            background: var(--bg-color);
            color: var(--text-color);
        }
        
        .user-message .edit-textarea {
            background: var(--message-bg-user);
            color: var(--message-text-user);
            border-color: rgba(255, 255, 255, 0.3);
        }
        
        .ai-message .edit-textarea {
            background: var(--message-bg-ai);
            color: var(--message-text-ai);
            border-color: var(--primary);
        }
        
        .edit-buttons {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            justify-content: flex-end;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 0.85rem;
            border-radius: 6px;
            cursor: pointer;
            border: none;
            font-weight: 500;
        }
        
        .btn-save {
            background: var(--secondary);
            color: white;
        }
        
        .btn-cancel {
            background: var(--light-gray);
            color: var(--gray);
        }
        
        .btn-small:hover {
            opacity: 0.8;
        }
        
        .typing-indicator {
            align-self: flex-start;
            background: var(--message-bg-ai);
            color: var(--message-text-ai);
            border: 1px solid var(--light-gray);
            padding: 16px 20px;
            border-radius: 18px;
            border-bottom-left-radius: 6px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-style: italic;
        }
        
        .typing-dots {
            display: flex;
            gap: 4px;
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--gray);
            animation: typing 1.4s infinite ease-in-out;
        }
        
        .typing-dot:nth-child(1) { animation-delay: 0s; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
            30% { transform: translateY(-10px); opacity: 1; }
        }
        
        .input-area {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }
        
        .input-area textarea {
            flex: 1;
            padding: 16px 20px;
            border-radius: 20px;
            border: 2px solid var(--light-gray);
            resize: none;
            font-size: 1rem;
            max-height: 150px;
            min-height: 60px;
            outline: none;
            transition: border 0.3s;
            line-height: 1.5;
            background: var(--bg-color);
            color: var(--text-color);
        }
        
        .input-area textarea:focus {
            border-color: var(--primary);
        }
        
        .send-button {
            background: var(--primary);
            color: white;
            border: none;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(124, 58, 237, 0.2);
        }
        
        .send-button:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(124, 58, 237, 0.3);
        }
        
        .send-button:disabled {
            background: var(--light-gray);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .error-message {
            background: var(--danger);
            color: white;
            padding: 12px 18px;
            border-radius: 10px;
            margin-bottom: 15px;
            text-align: center;
            animation: shake 0.5s ease;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        .memory-info {
            background: #dbeafe;
            color: #1e40af;
            padding: 10px 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            font-size: 0.9rem;
            text-align: center;
            border-left: 4px solid #3b82f6;
        }

        .dark-mode .memory-info {
            background: #1e3a8a;
            color: #dbeafe;
            border-left-color: #60a5fa;
        }
        
        .success-message {
            background: var(--secondary);
            color: white;
            padding: 12px 18px;
            border-radius: 10px;
            margin-bottom: 15px;
            text-align: center;
            animation: fadeIn 0.5s ease;
        }
        
        .clear-chat {
            background: var(--danger);
        }
        
        .clear-chat:hover {
            background: #dc2626;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s;
        }
        
        .modal-content {
            background-color: var(--bg-color);
            margin: 10% auto;
            padding: 30px;
            border-radius: 12px;
            width: 80%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
        }
        
        .modal h2 {
            margin-bottom: 20px;
            color: var(--dark);
        }
        
        .close {
            color: var(--gray);
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: var(--dark);
        }

        /* Color Picker Styles */
        .color-picker-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .color-picker-label {
            font-weight: 600;
            color: var(--gray);
            font-size: 0.9rem;
            min-width: 120px;
        }

        .color-picker {
            width: 60px;
            height: 40px;
            border: 2px solid var(--light-gray);
            border-radius: 8px;
            cursor: pointer;
            background: var(--quote-color);
        }

        .color-preview {
            padding: 8px 12px;
            border-radius: 6px;
            background: rgba(69, 245, 66, 0.1);
            color: var(--quote-color);
            font-weight: 600;
            flex: 1;
            text-align: center;
        }

        /* Rooms Styles */
        .rooms-section {
            margin-top: 20px;
        }

        .rooms-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
        }

        .room-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            border-radius: 8px;
            background: var(--bg-color);
            border: 1px solid var(--light-gray);
            cursor: pointer;
            transition: all 0.3s;
        }

        .room-item:hover {
            border-color: var(--primary);
        }

        .room-item.active {
            background: var(--primary);
            color: white;
        }

        .room-actions {
            display: flex;
            gap: 5px;
        }

        .room-action-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .room-action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .delete-room-btn {
            color: var(--danger);
        }

        .room-name {
            font-weight: 600;
            flex: 1;
        }

        .room-meta {
            font-size: 0.8rem;
            opacity: 0.7;
            margin-top: 2px;
        }

        .current-room-display {
            background: var(--light-gray);
            padding: 10px 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            font-size: 0.9rem;
            color: var(--text-color);
        }

        /* API Keys Management Styles */
        .api-keys-management {
            margin-top: 15px;
        }

        .api-keys-list {
            max-height: 120px;
            overflow-y: auto;
            margin-bottom: 10px;
            border: 1px solid var(--light-gray);
            border-radius: 8px;
            padding: 8px;
        }

        .api-key-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 8px;
            margin-bottom: 3px;
            border-radius: 6px;
            background: var(--light-gray);
            transition: all 0.3s;
            font-size: 0.8rem;
        }

        .api-key-item:hover {
            background: var(--gray);
            color: white;
        }

        .api-key-name {
            font-weight: 600;
            flex: 1;
        }

        .api-key-actions {
            display: flex;
            gap: 5px;
        }

        .api-key-action-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .api-key-action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .delete-api-key-btn {
            color: var(--danger);
        }

        .add-api-key-form {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-row {
            display: flex;
            gap: 8px;
        }

        .form-row input {
            flex: 1;
            padding: 8px 10px;
            font-size: 0.85rem;
        }
        
        @media (max-width: 768px) {
            body {
                padding: 0; /* Eliminar padding para m√≥viles */
            }

            .container {
                width: 100vw;
                height: 100vh;
                border-radius: 0;
            }

            .chat-container {
                flex-direction: column;
            }
            
            .sidebar {
                position: fixed;
                top: 0;
                left: -100%;
                width: 80%;
                max-width: 300px;
                height: 100vh;
                z-index: 1000;
                border-right: none;
                border-bottom: none;
                padding: 20px;
                transition: left 0.3s ease;
            }

            body.sidebar-open .sidebar {
                left: 0;
            }

            body.sidebar-open::before {
                content: '';
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 999;
            }
            
            .chat-area {
                padding: 15px;
                width: 100%;
            }

            .mobile-menu-btn {
                display: block;
            }

            .message {
                max-width: 90%;
            }
            
            .logo h1 {
                font-size: 1.3rem;
            }

            .actions-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .input-area textarea {
                min-height: 50px;
            }

            .send-button {
                width: 50px;
                height: 50px;
            }

            .form-row {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="chat-container">
            <div class="sidebar">
                <div class="current-room-display" id="current-room-display">Sala actual: General</div>
                <div class="config-section">
                    
                    <div class="form-group">
                        <label for="model-search">Buscar Modelo:</label>
                        <div class="model-search-container">
                            <input type="text" id="model-search" class="model-search-input" placeholder="Escribe para buscar (ej: 'ar' para claude-3.5-sonnet)" />
                            <div class="models-list" id="models-list">
                                <!-- Los items se generar√°n din√°micamente -->
                            </div>
                        </div>
                        <div class="model-display" id="model-display">Ning√∫n modelo seleccionado</div>
                    </div>
                    
                    <div class="api-keys-section">
                        <label for="api-key-select">API Activa:</label>
                        <select id="api-key-select">
                            <!-- Las opciones se generar√°n din√°micamente -->
                        </select>
                    </div>

                    <div class="api-keys-management">
                        <div class="api-keys-list" id="api-keys-list">
                            <!-- Las APIs se generar√°n din√°micamente -->
                        </div>
                        <div class="add-api-key-form">
                            <div class="form-row">
                                <input type="text" id="new-api-key-name" placeholder="Nombre de la API" />
                                <input type="text" id="new-api-key-value" placeholder="Clave de API" />
                            </div>
                        </div>
                    </div>
                    
                    <div class="actions-grid">
                        <button class="action-icon primary" id="add-api-key" title="A√±adir API">üîë</button>
                        <button class="action-icon primary" id="update-config" title="Actualizar Configuraci√≥n y Cargar Modelos">üîÑ</button>
                        <button class="action-icon danger" id="clear-chat" title="Limpiar Chat">üóëÔ∏è</button>
                        <button class="action-icon" id="new-room-btn" title="Nueva Sala">‚ûï</button>
                        <button class="action-icon" id="rooms-btn" title="Salas Creadas">üìã</button>
                        <button class="action-icon" id="edit-room-btn" title="Editar Sala">‚úèÔ∏è</button>
                        <button class="action-icon theme" id="theme-toggle" title="Cambiar tema">üåô</button>
                    </div>

                </div>
            </div>
            
            <div class="chat-area">
                <button id="mobile-menu-btn" class="mobile-menu-btn">‚ò∞</button>
                <div class="messages-container" id="messages-container">
                </div>
                
                <div class="input-area">
                    <textarea id="user-input" placeholder="Escribe tu mensaje aqu√≠... (Enter para enviar, Shift+Enter para nueva l√≠nea)"></textarea>
                    <button class="send-button" id="send-button">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M2 21L23 12L2 3V10L17 12L2 14V21Z" fill="currentColor"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Nueva Sala -->
    <div id="new-room-modal" class="modal">
        <div class="modal-content">
            <span class="close" id="close-new-room">&times;</span>
            <h2>Crear Nueva Sala</h2>
            <div class="form-group">
                <label for="room-name">Nombre de la Sala:</label>
                <input type="text" id="room-name" placeholder="Ej: Programaci√≥n, Dise√±o, etc.">
            </div>
            <div class="form-group">
                <label for="room-prompt">Prompt Personalizado:</label>
                <textarea id="room-prompt" rows="4" placeholder="Eres un asistente especializado en..."></textarea>
            </div>
            <button class="btn btn-primary" id="create-room">Crear Sala</button>
        </div>
    </div>

    <!-- Modal para Salas Creadas -->
    <div id="rooms-modal" class="modal">
        <div class="modal-content">
            <span class="close" id="close-rooms">&times;</span>
            <h2>Salas Creadas</h2>
            <h3>Salas Activas</h3>
            <div class="rooms-list" id="all-rooms-list">
                <!-- Las salas se generar√°n din√°micamente -->
            </div>
        </div>
    </div>

    <!-- Modal para Editar Sala -->
    <div id="edit-room-modal" class="modal">
        <div class="modal-content">
            <span class="close" id="close-edit-room">&times;</span>
            <h2>Editar Sala</h2>
            <div class="form-group">
                <label for="system-prompt">Prompt Base para IA:</label>
                <textarea id="system-prompt" rows="3" placeholder="Eres un asistente √∫til con memoria de conversaci√≥n. Recuerdas todo el historial del chat.">Eres un asistente √∫til con memoria de conversaci√≥n. Recuerdas todo el historial del chat.</textarea>
            </div>
            
            <div class="color-picker-group">
                <span class="color-picker-label">Color de Citas:</span>
                <input type="color" id="quote-color-picker" class="color-picker" value="#45f542">
                <div class="color-preview" id="color-preview">Texto de ejemplo entre "comillas"</div>
            </div>

            <div class="color-picker-group">
                <span class="color-picker-label">Color de Asteriscos:</span>
                <input type="color" id="asterisk-color-picker" class="color-picker" value="#ff0000">
                <div class="color-preview" id="asterisk-color-preview">Texto de ejemplo *con asteriscos*</div>
            </div>
            
            <button class="btn btn-primary" id="save-room">Guardar Cambios</button>
        </div>
    </div>

    <script>
        // Configuraci√≥n inicial
        let conversationHistory = [];
        let currentModel = localStorage.getItem('selectedModel') || '';
        let apiKey = localStorage.getItem('activeApiKey') || '';
        let systemPrompt = localStorage.getItem('systemPrompt') || 'Eres un asistente √∫til con memoria de conversaci√≥n. Recuerdas todo el historial del chat.';
        let quoteColor = localStorage.getItem('quoteColor') || '#45f542';
        let asteriskColor = localStorage.getItem('asteriskColor') || '#ff0000';
        let isDarkMode = localStorage.getItem('darkMode') === 'true';
        let allModels = [];
        
        // Sistema de APIs
        let apiKeys = JSON.parse(localStorage.getItem('apiKeys')) || [
            { id: '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', name: 'Cuenta 1' },
            { id: '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', name: 'Cuenta 2' },
            { id: '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', name: 'Cuenta 3' }
        ];
        
        // Sistema de salas
        let rooms = JSON.parse(localStorage.getItem('rooms')) || [
            {
                id: 'general',
                name: 'General',
                prompt: 'Eres un asistente √∫til con memoria de conversaci√≥n. Recuerdas todo el historial del chat.',
                history: [],
                createdAt: new Date().toISOString()
            }
        ];
        let currentRoomId = localStorage.getItem('currentRoomId') || 'general';
        
        // Elementos del DOM
        const messagesContainer = document.getElementById('messages-container');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const apiKeySelect = document.getElementById('api-key-select');
        const modelSearchInput = document.getElementById('model-search');
        const modelsList = document.getElementById('models-list');
        const modelDisplay = document.getElementById('model-display');
        const updateConfigButton = document.getElementById('update-config');
        const clearChatButton = document.getElementById('clear-chat');
        const newRoomBtn = document.getElementById('new-room-btn');
        const roomsBtn = document.getElementById('rooms-btn');
        const editRoomBtn = document.getElementById('edit-room-btn');
        const themeToggle = document.getElementById('theme-toggle');
        const newRoomModal = document.getElementById('new-room-modal');
        const closeNewRoom = document.getElementById('close-new-room');
        const roomNameInput = document.getElementById('room-name');
        const roomPromptInput = document.getElementById('room-prompt');
        const createRoomBtn = document.getElementById('create-room');
        const roomsModal = document.getElementById('rooms-modal');
        const closeRooms = document.getElementById('close-rooms');
        const allRoomsList = document.getElementById('all-rooms-list');
        const editRoomModal = document.getElementById('edit-room-modal');
        const closeEditRoom = document.getElementById('close-edit-room');
        const systemPromptInput = document.getElementById('system-prompt');
        const quoteColorPicker = document.getElementById('quote-color-picker');
        const colorPreview = document.getElementById('color-preview');
        const asteriskColorPicker = document.getElementById('asterisk-color-picker');
        const asteriskColorPreview = document.getElementById('asterisk-color-preview');
        const saveRoomBtn = document.getElementById('save-room');
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const currentRoomDisplay = document.getElementById('current-room-display');
        const apiKeysList = document.getElementById('api-keys-list');
        const newApiKeyName = document.getElementById('new-api-key-name');
        const newApiKeyValue = document.getElementById('new-api-key-value');
        const addApiKeyBtn = document.getElementById('add-api-key');
        
        // Inicializar tema y colores
        function initializeTheme() {
            if (isDarkMode) {
                document.documentElement.classList.add('dark-mode');
                themeToggle.textContent = '‚òÄÔ∏è';
            } else {
                document.documentElement.classList.remove('dark-mode');
                themeToggle.textContent = 'üåô';
            }
            
            // Aplicar color de citas
            document.documentElement.style.setProperty('--quote-color', quoteColor);
            quoteColorPicker.value = quoteColor;
            updateColorPreview();

            // Aplicar color de asteriscos
            document.documentElement.style.setProperty('--asterisk-color', asteriskColor);
            document.documentElement.style.setProperty('--asterisk-rgb', hexToRgb(asteriskColor));
            asteriskColorPicker.value = asteriskColor;
            updateAsteriskColorPreview();
        }

        function handleResize() {
            const isMobileNow = window.innerWidth <= 768;
            if (isMobileNow) {
                document.body.classList.add('mobile-view');
            } else {
                document.body.classList.remove('mobile-view', 'sidebar-open');
            }
        }
        
        // Funci√≥n para convertir hex a rgb
        function hexToRgb(hex) {
            hex = hex.replace('#', '');
            const r = parseInt(hex.substring(0, 2), 16);
            const g = parseInt(hex.substring(2, 4), 16);
            const b = parseInt(hex.substring(4, 6), 16);
            return `${r}, ${g}, ${b}`;
        }
        
        // Actualizar vista previa del color de citas
        function updateColorPreview() {
            colorPreview.style.color = quoteColor;
            colorPreview.style.background = `${quoteColor}20`;
        }
        
        // Actualizar vista previa del color de asteriscos
        function updateAsteriskColorPreview() {
            asteriskColorPreview.style.color = asteriskColor;
            asteriskColorPreview.style.background = `${asteriskColor}20`;
        }
        
        // Procesar texto para resaltar citas entre comillas, texto entre asteriscos y mantener saltos de l√≠nea
        function processSpecialText(text) {
            // Primero, procesar saltos de l√≠nea
            let processedText = text.replace(/\n/g, '<br>');
            
            // Luego, procesar texto entre comillas dobles
            const quoteRegex = /"([^"\\]*(\\.[^"\\]*)*)"/g;
            processedText = processedText.replace(quoteRegex, (match, content) => {
                return `<span class="quoted-text">"${content}"</span>`;
            });
            
            // Luego, procesar texto entre asteriscos simples
            const asteriskRegex = /\*([^*]+)\*/g;
            processedText = processedText.replace(asteriskRegex, (match, content) => {
                return `<span class="asterisk-text">${content}</span>`;
            });
            
            return processedText;
        }
        
        // Toggle modo oscuro
        function toggleDarkMode() {
            isDarkMode = !isDarkMode;
            localStorage.setItem('darkMode', isDarkMode);
            initializeTheme();
            
            // Reprocesar todos los mensajes existentes para aplicar nuevos estilos
            reprocessAllMessages();
        }
        
        // Reprocesar todos los mensajes para aplicar nuevos estilos
        function reprocessAllMessages() {
            const messageContents = document.querySelectorAll('.message-content');
            messageContents.forEach(content => {
                const originalText = content.textContent;
                content.innerHTML = processSpecialText(originalText);
            });
        }
        
        // Cargar lista de modelos desde OpenRouter
        async function loadModels() {
            const updateConfigBtn = document.getElementById('update-config');
            updateConfigBtn.textContent = 'üîÑ';
            updateConfigBtn.classList.add('btn-loading');
            updateConfigBtn.disabled = true;
            
            try {
                if (!apiKey) {
                    throw new Error('No hay API Key seleccionada');
                }
                
                const response = await fetch('https://openrouter.ai/api/v1/models', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'HTTP-Referer': window.location.href,
                        'X-Title': 'Chat IA con Memoria'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }
                
                const data = await response.json();
                allModels = data.data;
                populateModelsList(allModels);
                
                if (currentModel && allModels.find(m => m.id === currentModel)) {
                    updateModelDisplay(currentModel);
                    modelSearchInput.value = '';
                    modelsList.classList.remove('show');
                } else if (!currentModel && allModels.length > 0) {
                    currentModel = allModels[0].id;
                    updateModelDisplay(currentModel);
                }
                
                showSuccess('Modelos cargados exitosamente');
                
            } catch (error) {
                console.error('Error cargando modelos:', error);
                showError('No se pudieron cargar los modelos. Verifica tu API Key.');
                
                allModels = [
                    { id: 'anthropic/claude-3.5-sonnet', name: 'Claude 3.5 Sonnet' },
                    { id: 'meta-llama/llama-3.3-70b-instruct', name: 'Llama 3.3 70B' },
                    { id: 'openai/gpt-4o', name: 'GPT-4o' }
                ];
                populateModelsList(allModels);
                if (!currentModel) {
                    currentModel = allModels[0].id;
                    updateModelDisplay(currentModel);
                }
            } finally {
                updateConfigBtn.textContent = 'üîÑ';
                updateConfigBtn.classList.remove('btn-loading');
                updateConfigBtn.disabled = false;
            }
        }
        
        // Poblar la lista de modelos
        function populateModelsList(models) {
            modelsList.innerHTML = '';
            models.forEach(model => {
                const item = document.createElement('div');
                item.classList.add('model-item');
                item.dataset.modelId = model.id;
                item.textContent = `${model.name} (${model.id})`;
                item.addEventListener('click', () => selectModel(model.id));
                modelsList.appendChild(item);
            });
            if (models.length === 0) {
                const noResults = document.createElement('div');
                noResults.classList.add('model-item');
                noResults.textContent = 'No hay modelos disponibles';
                modelsList.appendChild(noResults);
            }
        }
        
        // Filtrar modelos
        function filterModels(searchTerm) {
            const filtered = allModels.filter(model => 
                model.name.toLowerCase().includes(searchTerm.toLowerCase()) || 
                model.id.toLowerCase().includes(searchTerm.toLowerCase())
            );
            populateModelsList(filtered);
        }
        
        // Seleccionar un modelo
        function selectModel(modelId) {
            currentModel = modelId;
            localStorage.setItem('selectedModel', modelId);
            updateModelDisplay(currentModel);
            modelsList.classList.remove('show');
            modelSearchInput.value = '';
        }
        
        // Actualizar display del modelo
        function updateModelDisplay(modelId) {
            const model = allModels.find(m => m.id === modelId);
            if (model) {
                modelDisplay.textContent = `${model.name} (${model.id})`;
                modelDisplay.classList.add('selected');
            } else {
                modelDisplay.textContent = 'Ning√∫n modelo seleccionado';
                modelDisplay.classList.remove('selected');
            }
        }
        
        // Generar respuesta de asistente
        async function generateAssistantResponse() {
            if (!currentModel) {
                showError('Selecciona un modelo antes de generar.');
                return;
            }
            
            if (!apiKey) {
                showError('Selecciona una API Key v√°lida.');
                return;
            }
            
            const typingIndicator = showTypingIndicator();
            
            try {
                const currentRoom = getCurrentRoom();
                const roomPrompt = currentRoom.prompt || systemPrompt;
                
                const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`,
                        'HTTP-Referer': window.location.href,
                        'X-Title': 'Chat IA con Memoria'
                    },
                    body: JSON.stringify({
                        model: currentModel,
                        messages: [
                            {
                                role: 'system',
                                content: roomPrompt
                            },
                            ...conversationHistory
                        ],
                        max_tokens: 4000
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || `Error HTTP: ${response.status}`);
                }
                
                const data = await response.json();
                const aiResponse = data.choices[0].message.content;
                
                const aiIndex = conversationHistory.length;
                conversationHistory.push({ role: 'assistant', content: aiResponse });
                
                // Guardar en el historial de la sala actual
                saveCurrentRoomHistory();
                
                addMessage(aiResponse, 'ai', aiIndex);
                
                showMemoryInfo();
                
            } catch (error) {
                console.error('Error:', error);
                let errorMsg = 'Error al conectar con la IA. ';
                
                if (error.message.includes('API') || error.message.includes('key')) {
                    errorMsg += 'Verifica tu API Key.';
                } else if (error.message.includes('model')) {
                    errorMsg += 'El modelo seleccionado no est√° disponible.';
                } else {
                    errorMsg += error.message;
                }
                
                showError(errorMsg);
            } finally {
                typingIndicator.remove();
            }
        }
        
        // Editar mensaje
        function initEdit(messageElement, historyIndex) {
            const header = messageElement.querySelector('.message-header');
            const content = messageElement.querySelector('.message-content');
            const originalText = content.textContent;
            
            const editForm = document.createElement('div');
            editForm.classList.add('edit-form');
            
            const textarea = document.createElement('textarea');
            textarea.classList.add('edit-textarea');
            textarea.value = originalText;
            textarea.placeholder = 'Edita el mensaje...';
            
            const buttons = document.createElement('div');
            buttons.classList.add('edit-buttons');
            
            const saveBtn = document.createElement('button');
            saveBtn.classList.add('btn-small', 'btn-save');
            saveBtn.textContent = 'Guardar';
            saveBtn.addEventListener('click', () => {
                const newText = textarea.value.trim();
                if (newText) {
                    content.innerHTML = processSpecialText(newText);
                    conversationHistory[historyIndex].content = newText;
                    messageElement.classList.remove('editing');
                    editForm.remove();
                    saveCurrentRoomHistory();
                    showSuccess('Mensaje editado y memoria actualizada');
                }
            });
            
            const cancelBtn = document.createElement('button');
            cancelBtn.classList.add('btn-small', 'btn-cancel');
            cancelBtn.textContent = 'Cancelar';
            cancelBtn.addEventListener('click', () => {
                messageElement.classList.remove('editing');
                editForm.remove();
            });
            
            buttons.appendChild(saveBtn);
            buttons.appendChild(cancelBtn);
            editForm.appendChild(textarea);
            editForm.appendChild(buttons);
            
            messageElement.appendChild(editForm);
            messageElement.classList.add('editing');
            textarea.focus();
        }
        
        // Regenerar
        async function initRegenerate(messageElement, historyIndex) {
            const role = conversationHistory[historyIndex].role;
            let truncateTo;
            
            if (role === 'user') {
                truncateTo = historyIndex + 1;
            } else {
                truncateTo = historyIndex;
            }
            
            conversationHistory = conversationHistory.slice(0, truncateTo);
            
            let startRemove;
            if (role === 'user') {
                startRemove = messageElement.nextSibling;
            } else {
                startRemove = messageElement;
            }
            while (startRemove) {
                const next = startRemove.nextSibling;
                startRemove.remove();
                startRemove = next;
            }
            
            sendButton.disabled = true;
            await generateAssistantResponse();
            sendButton.disabled = false;
            showSuccess('Respuesta regenerada');
        }
        
        // Copiar mensaje
        function copyMessage(text) {
            navigator.clipboard.writeText(text).then(() => {
                showSuccess('Mensaje copiado al portapapeles');
            }).catch(err => {
                console.error('Error al copiar:', err);
                showError('Error al copiar mensaje');
            });
        }
        
        // Enviar mensaje
        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message || !currentModel) {
                showError('Selecciona un modelo antes de enviar.');
                return;
            }
            
            if (!apiKey) {
                showError('Selecciona una API Key v√°lida.');
                return;
            }
            
            const userIndex = conversationHistory.length;
            conversationHistory.push({ role: 'user', content: message });
            
            addMessage(message, 'user', userIndex);
            userInput.value = '';
            sendButton.disabled = true;
            
            await generateAssistantResponse();
            
            sendButton.disabled = false;
            userInput.focus();
        }
        
        // Agregar mensaje al chat
        function addMessage(text, sender, historyIndex = null) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message');
            messageElement.classList.add(sender === 'user' ? 'user-message' : 'ai-message');
            
            if (historyIndex !== null) {
                messageElement.dataset.historyIndex = historyIndex;
            }
            
            const header = document.createElement('div');
            header.classList.add('message-header');
            
            const senderLabel = document.createElement('span');
            senderLabel.textContent = sender === 'user' ? 'T√∫' : 'Asistente IA';
            
            header.appendChild(senderLabel);
            
            if (historyIndex !== null) {
                const actions = document.createElement('div');
                actions.classList.add('actions');
                
                const copyBtn = document.createElement('button');
                copyBtn.classList.add('action-btn');
                copyBtn.textContent = 'üìã';
                copyBtn.title = 'Copiar mensaje';
                copyBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    copyMessage(text);
                });
                actions.appendChild(copyBtn);
                
                const editBtn = document.createElement('button');
                editBtn.classList.add('action-btn');
                editBtn.textContent = '‚úèÔ∏è';
                editBtn.title = 'Editar';
                editBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    initEdit(messageElement, historyIndex);
                });
                actions.appendChild(editBtn);
                
                const regenBtn = document.createElement('button');
                regenBtn.classList.add('action-btn');
                regenBtn.textContent = 'üîÑ';
                regenBtn.title = 'Regenerar';
                regenBtn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    await initRegenerate(messageElement, historyIndex);
                });
                actions.appendChild(regenBtn);
                
                header.appendChild(actions);
            }
            
            const content = document.createElement('div');
            content.classList.add('message-content');
            content.innerHTML = processSpecialText(text);
            
            messageElement.appendChild(header);
            messageElement.appendChild(content);
            
            messagesContainer.appendChild(messageElement);
            scrollToBottom();
            
            return messageElement;
        }
        
        // Mostrar indicador de escritura
        function showTypingIndicator() {
            const typingElement = document.createElement('div');
            typingElement.classList.add('typing-indicator');
            typingElement.innerHTML = `
                Procesando...
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;
            
            messagesContainer.appendChild(typingElement);
            scrollToBottom();
            
            return typingElement;
        }
        
        // Mostrar informaci√≥n de memoria
        function showMemoryInfo() {
            const existingInfo = document.querySelector('.memory-info');
            if (existingInfo) {
                existingInfo.remove();
            }
            
            const memoryElement = document.createElement('div');
            memoryElement.classList.add('memory-info');
            memoryElement.textContent = `Memoria: ${conversationHistory.length} mensajes en esta conversaci√≥n`;
            
            messagesContainer.appendChild(memoryElement);
            scrollToBottom();
            
            setTimeout(() => {
                if (memoryElement.parentNode) {
                    memoryElement.remove();
                }
            }, 5000);
        }
        
        // Mostrar error
        function showError(message) {
            const errorElement = document.createElement('div');
            errorElement.classList.add('error-message');
            errorElement.textContent = message;
            
            messagesContainer.appendChild(errorElement);
            scrollToBottom();
            
            setTimeout(() => {
                if (errorElement.parentNode) {
                    errorElement.remove();
                }
            }, 7000);
        }
        
        // Mostrar √©xito
        function showSuccess(message) {
            const successElement = document.createElement('div');
            successElement.classList.add('success-message');
            successElement.textContent = message;
            
            messagesContainer.appendChild(successElement);
            scrollToBottom();
            
            setTimeout(() => {
                if (successElement.parentNode) {
                    successElement.remove();
                }
            }, 3000);
        }
        
        // Desplazar al final del chat
        function scrollToBottom() {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // Actualizar configuraci√≥n
        function updateConfig() {
            const newApiKey = apiKeySelect.value;
            if (newApiKey) {
                apiKey = newApiKey;
                localStorage.setItem('activeApiKey', apiKey);
            }
            
            if (currentModel) {
                const model = allModels.find(m => m.id === currentModel);
                const confirmation = addMessage(`Configuraci√≥n actualizada: ${model ? model.name : currentModel}`, 'ai');
                setTimeout(() => {
                    if (confirmation.parentNode) {
                        confirmation.remove();
                    }
                }, 3000);
            }
        }
        
        // Limpiar chat
        function clearChat() {
            conversationHistory = [];
            saveCurrentRoomHistory();
            messagesContainer.innerHTML = '';
            showSuccess('Chat limpiado');
        }
        
        // Sistema de salas
        function getCurrentRoom() {
            return rooms.find(room => room.id === currentRoomId) || rooms[0];
        }
        
        function saveCurrentRoomHistory() {
            const currentRoom = getCurrentRoom();
            if (currentRoom) {
                currentRoom.history = [...conversationHistory];
                saveRooms();
            }
        }
        
        function saveRooms() {
            localStorage.setItem('rooms', JSON.stringify(rooms));
        }
        
        function createRoom(name, prompt) {
            const newRoom = {
                id: 'room_' + Date.now(),
                name: name,
                prompt: prompt || systemPrompt,
                history: [],
                createdAt: new Date().toISOString()
            };
            
            rooms.push(newRoom);
            saveRooms();
            renderRoomsList();
            switchToRoom(newRoom.id);
            showSuccess(`Sala "${name}" creada`);
        }
        
        function deleteRoom(roomId) {
            if (rooms.length <= 1) {
                showError('No puedes eliminar la √∫nica sala existente');
                return;
            }
            
            const roomName = rooms.find(r => r.id === roomId).name;
            rooms = rooms.filter(room => room.id !== roomId);
            saveRooms();
            renderRoomsList();
            
            // Si eliminamos la sala actual, cambiar a la primera disponible
            if (currentRoomId === roomId) {
                switchToRoom(rooms[0].id);
            }
            
            showSuccess(`Sala "${roomName}" eliminada`);
        }
        
        function switchToRoom(roomId) {
            currentRoomId = roomId;
            localStorage.setItem('currentRoomId', roomId);
            
            const room = getCurrentRoom();
            conversationHistory = [...room.history];
            
            // Actualizar UI
            updateCurrentRoomDisplay();
            renderRoomsList();
            
            // Limpiar y cargar mensajes de la nueva sala
            messagesContainer.innerHTML = '';
            conversationHistory.forEach((message, index) => {
                addMessage(message.content, message.role === 'user' ? 'user' : 'ai', index);
            });
            
            scrollToBottom();
            showSuccess(`Cambiado a sala: ${room.name}`);
        }
        
        function updateCurrentRoomDisplay() {
            const room = getCurrentRoom();
            currentRoomDisplay.textContent = `Sala actual: ${room.name}`;
        }
        
        function renderRoomsList() {
            // Renderizar lista de salas en el modal
            allRoomsList.innerHTML = '';
            rooms.forEach(room => {
                const roomElement = document.createElement('div');
                roomElement.classList.add('room-item');
                if (room.id === currentRoomId) {
                    roomElement.classList.add('active');
                }
                
                roomElement.innerHTML = `
                    <div>
                        <div class="room-name">${room.name}</div>
                        <div class="room-meta">${room.history.length} mensajes</div>
                    </div>
                    <div class="room-actions">
                        <button class="room-action-btn delete-room-btn" title="Eliminar sala">üóëÔ∏è</button>
                    </div>
                `;
                
                roomElement.addEventListener('click', (e) => {
                    if (!e.target.closest('.room-actions')) {
                        switchToRoom(room.id);
                        roomsModal.style.display = 'none';
                    }
                });
                
                const deleteBtn = roomElement.querySelector('.delete-room-btn');
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (confirm(`¬øEst√°s seguro de que quieres eliminar la sala "${room.name}"?`)) {
                        deleteRoom(room.id);
                    }
                });
                
                allRoomsList.appendChild(roomElement);
            });
        }
        
        // Sistema de gesti√≥n de APIs
        function saveApiKeys() {
            localStorage.setItem('apiKeys', JSON.stringify(apiKeys));
        }
        
        function renderApiKeys() {
            // Actualizar select de API Keys
            apiKeySelect.innerHTML = '';
            apiKeys.forEach(api => {
                const option = document.createElement('option');
                option.value = api.id;
                option.textContent = api.name;
                if (api.id === apiKey) {
                    option.selected = true;
                }
                apiKeySelect.appendChild(option);
            });
            
            // Actualizar lista de API Keys
            apiKeysList.innerHTML = '';
            apiKeys.forEach((api, index) => {
                const apiElement = document.createElement('div');
                apiElement.classList.add('api-key-item');
                
                apiElement.innerHTML = `
                    <div>
                        <div class="api-key-name">${api.name}</div>
                        <div class="api-key-meta">${api.id.substring(0, 10)}...</div>
                    </div>
                    <div class="api-key-actions">
                        <button class="api-key-action-btn delete-api-key-btn" title="Eliminar API">üóëÔ∏è</button>
                    </div>
                `;
                
                const deleteBtn = apiElement.querySelector('.delete-api-key-btn');
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (confirm(`¬øEst√°s seguro de que quieres eliminar la API "${api.name}"?`)) {
                        deleteApiKey(index);
                    }
                });
                
                apiKeysList.appendChild(apiElement);
            });
        }
        
        function addApiKey(name, key) {
            if (!name.trim() || !key.trim()) {
                showError('El nombre y la clave de API son obligatorios');
                return;
            }
            
            // Verificar si ya existe una API con ese nombre
            if (apiKeys.some(api => api.name === name)) {
                showError('Ya existe una API con ese nombre');
                return;
            }
            
            const newApi = {
                id: key,
                name: name
            };
            
            apiKeys.push(newApi);
            saveApiKeys();
            renderApiKeys();
            
            // Si es la primera API, seleccionarla autom√°ticamente
            if (apiKeys.length === 1) {
                apiKey = newApi.id;
                localStorage.setItem('activeApiKey', apiKey);
                apiKeySelect.value = apiKey;
            }
            
            newApiKeyName.value = '';
            newApiKeyValue.value = '';
            showSuccess(`API "${name}" a√±adida correctamente`);
        }
        
        function deleteApiKey(index) {
            if (apiKeys.length <= 1) {
                showError('No puedes eliminar la √∫nica API existente');
                return;
            }
            
            const apiName = apiKeys[index].name;
            const deletedApiKey = apiKeys[index].id;
            
            // Si estamos eliminando la API activa, cambiar a otra
            if (deletedApiKey === apiKey) {
                const newIndex = index === 0 ? 1 : 0;
                apiKey = apiKeys[newIndex].id;
                localStorage.setItem('activeApiKey', apiKey);
            }
            
            apiKeys.splice(index, 1);
            saveApiKeys();
            renderApiKeys();
            showSuccess(`API "${apiName}" eliminada`);
        }
        
        // Event Listeners
        sendButton.addEventListener('click', sendMessage);
        
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        updateConfigButton.addEventListener('click', () => {
            updateConfig();
            loadModels();
        });
        
        clearChatButton.addEventListener('click', clearChat);
        
        modelSearchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value;
            if (searchTerm.length > 0) {
                filterModels(searchTerm);
                modelsList.classList.add('show');
            } else {
                populateModelsList(allModels);
                modelsList.classList.remove('show');
            }
        });
        
        modelSearchInput.addEventListener('focus', () => {
            if (allModels.length > 0) {
                modelsList.classList.add('show');
                filterModels(modelSearchInput.value);
            }
        });
        
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.model-search-container')) {
                modelsList.classList.remove('show');
            }

            // Cerrar sidebar en mobile si se hace click fuera
            if (window.innerWidth <= 768 && document.body.classList.contains('sidebar-open') && 
                !e.target.closest('.sidebar') && !e.target.closest('.mobile-menu-btn')) {
                document.body.classList.remove('sidebar-open');
            }
        });
        
        userInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 150) + 'px';
        });
        
        // Tema oscuro
        themeToggle.addEventListener('click', toggleDarkMode);

        // Mobile menu toggle
        if (mobileMenuBtn) {
            mobileMenuBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                document.body.classList.toggle('sidebar-open');
            });
        }
        
        // Modal Nueva Sala
        newRoomBtn.addEventListener('click', () => {
            newRoomModal.style.display = 'block';
            roomNameInput.value = '';
            roomPromptInput.value = '';
            document.body.classList.remove('sidebar-open'); // Cerrar sidebar si est√° abierto
        });
        
        closeNewRoom.addEventListener('click', () => {
            newRoomModal.style.display = 'none';
        });
        
        createRoomBtn.addEventListener('click', () => {
            const name = roomNameInput.value.trim();
            const prompt = roomPromptInput.value.trim();
            
            if (!name) {
                showError('El nombre de la sala es obligatorio');
                return;
            }
            
            createRoom(name, prompt);
            newRoomModal.style.display = 'none';
        });
        
        window.addEventListener('click', (e) => {
            if (e.target === newRoomModal) {
                newRoomModal.style.display = 'none';
            }
        });
        
        // Modal Salas Creadas
        roomsBtn.addEventListener('click', () => {
            roomsModal.style.display = 'block';
            document.body.classList.remove('sidebar-open'); // Cerrar sidebar si est√° abierto
        });
        
        closeRooms.addEventListener('click', () => {
            roomsModal.style.display = 'none';
        });
        
        window.addEventListener('click', (e) => {
            if (e.target === roomsModal) {
                roomsModal.style.display = 'none';
            }
        });
        
        // Modal Editar Sala
        editRoomBtn.addEventListener('click', () => {
            editRoomModal.style.display = 'block';
            systemPromptInput.value = systemPrompt;
            document.body.classList.remove('sidebar-open'); // Cerrar sidebar si est√° abierto
        });
        
        closeEditRoom.addEventListener('click', () => {
            editRoomModal.style.display = 'none';
        });
        
        // Color picker para citas
        quoteColorPicker.addEventListener('input', (e) => {
            quoteColor = e.target.value;
            updateColorPreview();
        });
        
        // Color picker para asteriscos
        asteriskColorPicker.addEventListener('input', (e) => {
            asteriskColor = e.target.value;
            updateAsteriskColorPreview();
        });
        
        saveRoomBtn.addEventListener('click', () => {
            systemPrompt = systemPromptInput.value.trim();
            localStorage.setItem('systemPrompt', systemPrompt);
            localStorage.setItem('quoteColor', quoteColor);
            localStorage.setItem('asteriskColor', asteriskColor);
            document.documentElement.style.setProperty('--quote-color', quoteColor);
            document.documentElement.style.setProperty('--asterisk-color', asteriskColor);
            document.documentElement.style.setProperty('--asterisk-rgb', hexToRgb(asteriskColor));
            editRoomModal.style.display = 'none';
            reprocessAllMessages();
            showSuccess('Configuraci√≥n de sala guardada');
        });
        
        window.addEventListener('click', (e) => {
            if (e.target === editRoomModal) {
                editRoomModal.style.display = 'none';
            }
        });

        // Gesti√≥n de APIs
        addApiKeyBtn.addEventListener('click', () => {
            addApiKey(newApiKeyName.value.trim(), newApiKeyValue.value.trim());
        });
        
        apiKeySelect.addEventListener('change', (e) => {
            apiKey = e.target.value;
            localStorage.setItem('activeApiKey', apiKey);
            showSuccess('API Key cambiada');
        });

        // Handle resize for mobile detection
        window.addEventListener('resize', handleResize);
        
        // Inicializar
        initializeTheme();
        renderApiKeys();
        if (apiKeys.length > 0 && !apiKey) {
            apiKey = apiKeys[0].id;
            localStorage.setItem('activeApiKey', apiKey);
        }
        apiKeySelect.value = apiKey;
        loadModels();
        updateCurrentRoomDisplay();
        renderRoomsList();
        handleResize();
        
        // Cargar historial de la sala actual al iniciar
        const currentRoom = getCurrentRoom();
        conversationHistory = [...currentRoom.history];
        conversationHistory.forEach((message, index) => {
            addMessage(message.content, message.role === 'user' ? 'user' : 'ai', index);
        });
        scrollToBottom();
    </script>
</body>
</html>
